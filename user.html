<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoulCare - User Dashboard</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/user.css">
    
    <!-- Voiceflow Chatbot -->
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function() {
            (function(d, t) {
                var v = d.createElement(t), s = d.getElementsByTagName(t)[0];
                v.onload = function() {
                    if (window.voiceflow && window.voiceflow.chat) {
                        window.voiceflow.chat.load({
                            verify: { projectID: '6800d989037becb70886834f' },
                            url: 'https://general-runtime.voiceflow.com',
                            versionID: 'production',
                            voice: {
                                url: "https://runtime-api.voiceflow.com"
                            }
                        });
                    }
                }
                v.src = "https://cdn.voiceflow.com/widget-next/bundle.mjs"; 
                v.type = "text/javascript"; 
                if (s) {
                    s.parentNode.insertBefore(v, s);
                } else {
                    d.getElementsByTagName('head')[0].appendChild(v);
                }
            })(document, 'script');
        });
    </script>
</head>
<body>
    <header>
        <nav class="container">
            <a href="index.html" class="logo"><img src="img/logo.png" alt="SoulCare Logo" class="logo-img">SoulCare</a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="#profile">Profile</a></li>
                <li><a href="#sessions">Sessions</a></li>
                <li><a href="#resources">Resources</a></li>
                <li><a href="#" id="logout-btn" class="btn btn-outline">Logout</a></li>
            </ul>
            <div class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </div>
        </nav>
    </header>

    <main class="dashboard">
        <div class="container">
            <div class="dashboard-grid">
                <aside class="sidebar">
                    <div class="user-profile">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <h3 id="user-name">Loading...</h3>
                    </div>
                    <ul class="sidebar-menu">
                        <li><a href="#overview" class="active"><i class="fas fa-home"></i> Overview</a></li>
                        <li><a href="#sessions"><i class="fas fa-calendar"></i> My Sessions</a></li>
                        <li><a href="#progress"><i class="fas fa-chart-line"></i> Progress</a></li>
                        <li><a href="#resources"><i class="fas fa-book"></i> Resources</a></li>
                        <li><a href="#messages"><i class="fas fa-envelope"></i> Messages</a></li>
                        <li><a href="#settings"><i class="fas fa-cog"></i> Settings</a></li>
                    </ul>
                </aside>

                <div class="main-content">
                    <div class="dashboard-header">
                        <div class="welcome-message">
                            <h1>Welcome back, <span id="welcome-name">User</span>!</h1>
                            <p>Here's your wellness journey overview</p>
                        </div>
                    </div>

                    <div class="user-details">
                        <h3>Your Profile Information</h3>
                        <p><strong>Name:</strong> <span id="profile-name">Loading...</span></p>
                        <p><strong>Email:</strong> <span id="profile-email">Loading...</span></p>
                        <p><strong>Age:</strong> <span id="profile-age">Loading...</span></p>
                        <p><strong>Experience:</strong> <span id="profile-experience">Loading...</span></p>
                        <button id="edit-profile-btn" class="btn btn-primary">Edit Profile</button>
                        
                        <!-- Edit Profile Form (Initially Hidden) -->
                        <form id="edit-profile-form" style="display: none; margin-top: 20px;">
                            <div style="margin-bottom: 15px;">
                                <label for="edit-name">Name:</label>
                                <input type="text" id="edit-name" required style="width: 100%; padding: 8px; margin-top: 5px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="edit-age">Age:</label>
                                <input type="number" id="edit-age" required style="width: 100%; padding: 8px; margin-top: 5px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="edit-experience">Experience:</label>
                                <input type="text" id="edit-experience" required style="width: 100%; padding: 8px; margin-top: 5px;">
                            </div>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                            <button type="button" id="cancel-edit" class="btn btn-outline">Cancel</button>
                        </form>
                    </div>

                    <!-- Mood Selection Section -->
                    <div class="mood-section">
                        <h3>How are you feeling today?</h3>
                        <div class="mood-container">
                            <div class="mood-selection">
                                <div class="mood-grid">
                                    <div class="mood-item" data-mood="Happy">
                                        <img src="img/mood/happy.png" alt="Happy">
                                        <span>Happy</span>
                                    </div>
                                    <div class="mood-item" data-mood="Middle">
                                        <img src="img/mood/middle.png" alt="Middle">
                                        <span>Middle</span>
                                    </div>
                                    <div class="mood-item" data-mood="Anxiety">
                                        <img src="img/mood/anxiety.png" alt="Anxiety">
                                        <span>Anxiety</span>
                                    </div>
                                    <div class="mood-item" data-mood="Sad">
                                        <img src="img/mood/sad.png" alt="Sad">
                                        <span>Sad</span>
                                    </div>
                                    <div class="mood-item" data-mood="Big Sad">
                                        <img src="img/mood/big-sad.png" alt="Big Sad">
                                        <span>Big Sad</span>
                                    </div>
                                    <div class="mood-item" data-mood="Big Anger">
                                        <img src="img/mood/big-anger.png" alt="Big Anger">
                                        <span>Big Anger</span>
                                    </div>
                                    <div class="mood-item" data-mood="Oh">
                                        <img src="img/mood/oh.png" alt="Oh">
                                        <span>Oh</span>
                                    </div>
                                    <div class="mood-item" data-mood="Silly">
                                        <img src="img/mood/silly.png" alt="Silly">
                                        <span>Silly</span>
                                    </div>
                                    <div class="mood-item" data-mood="Idk">
                                        <img src="img/mood/idk.png" alt="Idk">
                                        <span>Idk</span>
                                    </div>
                                </div>
                            </div>
                            <div class="current-mood-display">
                                <h3>Current Mood</h3>
                                <div class="current-mood-content">
                                    <img id="current-mood-img" src="img/mood/happy.png" alt="Current Mood" style="display: none;">
                                    <p id="current-mood">Not selected</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="quick-stats">
                        <div class="stat-card">
                            <h3>5</h3>
                            <p>Sessions Completed</p>
                        </div>
                        <div class="stat-card">
                            <h3>2</h3>
                            <p>Upcoming Sessions</p>
                        </div>
                        <div class="stat-card">
                            <h3>3</h3>
                            <p>Goals Achieved</p>
                        </div>
                        <div class="stat-card">
                            <h3>80%</h3>
                            <p>Progress</p>
                        </div>
                    </div>

                    <section class="upcoming-sessions">
                        <h2>Upcoming Sessions</h2>
                        <div class="session-card">
                            <div class="session-info">
                                <h3>Stress Management</h3>
                                <p class="session-time">Tomorrow, 2:00 PM</p>
                            </div>
                            <div class="session-actions">
                                <button class="btn btn-primary">Join</button>
                                <button class="btn btn-outline">Reschedule</button>
                            </div>
                        </div>
                        <div class="session-card">
                            <div class="session-info">
                                <h3>Anxiety Relief</h3>
                                <p class="session-time">Friday, 11:00 AM</p>
                            </div>
                            <div class="session-actions">
                                <button class="btn btn-primary">Join</button>
                                <button class="btn btn-outline">Reschedule</button>
                            </div>
                        </div>
                    </section>

                    <section class="progress-section">
                        <h2>Your Progress</h2>
                        <div class="progress-item">
                            <h3>Stress Management</h3>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 75%"></div>
                            </div>
                            <p>75% Complete</p>
                        </div>
                        <div class="progress-item">
                            <h3>Anxiety Relief</h3>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 60%"></div>
                            </div>
                            <p>60% Complete</p>
                        </div>
                    </section>

                    <section class="resources-section">
                        <h2>Recommended Resources</h2>
                        <div class="resources-grid">
                            <div class="resource-card">
                                <h3>Meditation Guide</h3>
                                <p>Learn basic meditation techniques for stress relief</p>
                                <a href="#" class="btn btn-primary">Start Learning</a>
                            </div>
                            <div class="resource-card">
                                <h3>Sleep Better</h3>
                                <p>Tips and techniques for better sleep quality</p>
                                <a href="#" class="btn btn-primary">Read More</a>
                            </div>
                            <div class="resource-card">
                                <h3>Mindfulness Exercises</h3>
                                <p>Daily exercises to improve mindfulness</p>
                                <a href="#" class="btn btn-primary">Try Now</a>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </main>

    <!-- Firebase Scripts -->
    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { logOut } from './auth.js';
        import { doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', function() {
            // Cache DOM elements
            const elements = {
                userName: document.getElementById('user-name'),
                welcomeName: document.getElementById('welcome-name'),
                profileName: document.getElementById('profile-name'),
                profileEmail: document.getElementById('profile-email'),
                profileAge: document.getElementById('profile-age'),
                profileExperience: document.getElementById('profile-experience'),
                logoutBtn: document.getElementById('logout-btn'),
                editProfileBtn: document.getElementById('edit-profile-btn'),
                editProfileForm: document.getElementById('edit-profile-form'),
                editNameInput: document.getElementById('edit-name'),
                editAgeInput: document.getElementById('edit-age'),
                editExperienceInput: document.getElementById('edit-experience'),
                cancelEditBtn: document.getElementById('cancel-edit'),
                offlineIndicator: document.querySelector('.offline-indicator'),
                mobileMenuBtn: document.querySelector('.mobile-menu-btn'),
                sidebar: document.querySelector('.sidebar'),
                navLinks: document.querySelector('.nav-links'),
                currentMood: document.getElementById('current-mood'),
                currentMoodImg: document.getElementById('current-mood-img'),
                moodItems: document.querySelectorAll('.mood-item')
            };

            // Mobile menu toggle
            if (elements.mobileMenuBtn && elements.sidebar && elements.navLinks) {
                elements.mobileMenuBtn.addEventListener('click', function() {
                    elements.sidebar.classList.toggle('active');
                    elements.navLinks.classList.toggle('active');
                });

                // Close mobile menu when clicking outside
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.sidebar') && !e.target.closest('.mobile-menu-btn')) {
                        elements.sidebar.classList.remove('active');
                        elements.navLinks.classList.remove('active');
                    }
                });
            }

            // Safely update DOM element
            function safeUpdateElement(element, value, defaultValue = 'Not provided') {
                if (element) {
                    element.textContent = value || defaultValue;
                }
            }

            // Add offline status indicator if it doesn't exist
            if (!elements.offlineIndicator) {
                const profileSection = document.querySelector('.user-profile');
                if (profileSection) {
                    const offlineIndicator = document.createElement('div');
                    offlineIndicator.className = 'offline-indicator';
                    offlineIndicator.style.display = 'none';
                    offlineIndicator.innerHTML = '<i class="fas fa-wifi-slash"></i> You are offline. Some features may be limited.';
                    profileSection.insertBefore(offlineIndicator, profileSection.firstChild);
                    elements.offlineIndicator = offlineIndicator;
                }
            }

            // Handle mood selection
            if (elements.moodItems) {
                elements.moodItems.forEach(item => {
                    item.addEventListener('click', async function() {
                        const selectedMood = this.getAttribute('data-mood');
                        const moodImage = this.querySelector('img').src;
                        const user = auth.currentUser;
                        
                        if (!user) return;

                        try {
                            // Remove selected class from all items
                            elements.moodItems.forEach(i => i.classList.remove('selected'));
                            // Add selected class to clicked item
                            this.classList.add('selected');

                            // Update current mood display
                            if (elements.currentMood) {
                                elements.currentMood.textContent = selectedMood;
                            }
                            if (elements.currentMoodImg) {
                                elements.currentMoodImg.src = moodImage;
                                elements.currentMoodImg.style.display = 'block';
                            }

                            // Save to Firebase
                            await updateDoc(doc(db, "users", user.uid), {
                                currentMood: selectedMood,
                                currentMoodImage: moodImage,
                                lastMoodUpdate: new Date()
                            });

                            console.log("Mood updated successfully:", selectedMood);
                        } catch (error) {
                            console.error("Error updating mood:", error);
                            alert("Error updating mood. Please try again.");
                        }
                    });
                });
            }

            // Load current mood from Firebase
            async function loadCurrentMood(userId) {
                try {
                    const userDoc = await getDoc(doc(db, "users", userId));
                    if (userDoc.exists() && userDoc.data().currentMood) {
                        const userData = userDoc.data();
                        if (elements.currentMood) {
                            elements.currentMood.textContent = userData.currentMood;
                        }
                        if (elements.currentMoodImg && userData.currentMoodImage) {
                            elements.currentMoodImg.src = userData.currentMoodImage;
                            elements.currentMoodImg.style.display = 'block';
                        }
                        // Add selected class to current mood item
                        elements.moodItems.forEach(item => {
                            if (item.getAttribute('data-mood') === userData.currentMood) {
                                item.classList.add('selected');
                            }
                        });
                    }
                } catch (error) {
                    console.error("Error loading mood:", error);
                }
            }

            // Check authentication state
            auth.onAuthStateChanged(async function(user) {
                if (user) {
                    // Load current mood when user is authenticated
                    await loadCurrentMood(user.uid);
                    
                    // User is signed in
                    safeUpdateElement(elements.userName, user.displayName);
                    safeUpdateElement(elements.welcomeName, user.displayName);
                    
                    // Get additional user data from Firestore
                    try {
                        // Check if we're online
                        if (!navigator.onLine) {
                            if (elements.offlineIndicator) {
                                elements.offlineIndicator.style.display = 'block';
                            }
                            safeUpdateElement(elements.profileName, 'Offline - Please check your internet connection');
                            safeUpdateElement(elements.profileEmail, user.email);
                            return;
                        }
                        
                        const userDoc = await getDoc(doc(db, "users", user.uid));
                        console.log("Checking Firestore for user ID:", user.uid);
                        
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            console.log("User data from Firestore:", userData);
                            
                            // Update all profile fields with user data
                            safeUpdateElement(elements.profileName, userData.name);
                            safeUpdateElement(elements.profileEmail, userData.email || user.email);
                            safeUpdateElement(elements.profileAge, userData.age);
                            safeUpdateElement(elements.profileExperience, userData.experience);
                            
                            // Update header name displays
                            safeUpdateElement(elements.userName, userData.name);
                            safeUpdateElement(elements.welcomeName, userData.name);
                            
                            if (elements.offlineIndicator) {
                                elements.offlineIndicator.style.display = 'none';
                            }
                        } else {
                            console.log("No user data found in Firestore for ID:", user.uid);
                            // Create new user document if it doesn't exist
                            try {
                                const userData = {
                                    name: user.displayName || 'Not provided',
                                    email: user.email,
                                    age: 'Not provided',
                                    experience: 'Not provided',
                                    createdAt: new Date()
                                };
                                await setDoc(doc(db, "users", user.uid), userData);
                                console.log("Created new user document in Firestore:", userData);
                                
                                // Update display with the new data
                                safeUpdateElement(elements.profileName, userData.name);
                                safeUpdateElement(elements.profileEmail, userData.email);
                            } catch (error) {
                                console.error("Error creating user document:", error);
                                // Set default values if creation fails
                                safeUpdateElement(elements.profileName, user.displayName);
                                safeUpdateElement(elements.profileEmail, user.email);
                            }
                        }
                    } catch (error) {
                        console.error("Error getting user data:", error);
                        if (error.code === 'unavailable' || error.message.includes('offline')) {
                            if (elements.offlineIndicator) {
                                elements.offlineIndicator.style.display = 'block';
                            }
                            safeUpdateElement(elements.profileName, 'Offline - Please check your internet connection');
                            safeUpdateElement(elements.profileEmail, user.email);
                        } else {
                            safeUpdateElement(elements.profileName, 'Error loading data');
                            safeUpdateElement(elements.profileEmail, user.email);
                        }
                    }
                } else {
                    // User is signed out, redirect to index page
                    window.location.href = 'index.html';
                }
            });

            // Event Listeners
            if (elements.logoutBtn) {
                elements.logoutBtn.addEventListener('click', function() {
                    logOut().then(() => {
                        window.location.href = 'index.html';
                    }).catch((error) => {
                        console.error('Error signing out:', error);
                    });
                });
            }

            if (elements.editProfileBtn && elements.editProfileForm) {
                elements.editProfileBtn.addEventListener('click', function() {
                    elements.editProfileForm.style.display = 'block';
                    elements.editProfileBtn.style.display = 'none';
                    
                    // Populate form with current values
                    if (elements.editNameInput) {
                        elements.editNameInput.value = elements.profileName?.textContent === 'Not provided' ? '' : elements.profileName?.textContent;
                    }
                    if (elements.editAgeInput) {
                        elements.editAgeInput.value = elements.profileAge?.textContent === 'Not provided' ? '' : elements.profileAge?.textContent;
                    }
                    if (elements.editExperienceInput) {
                        elements.editExperienceInput.value = elements.profileExperience?.textContent === 'Not provided' ? '' : elements.profileExperience?.textContent;
                    }
                });
            }

            if (elements.cancelEditBtn) {
                elements.cancelEditBtn.addEventListener('click', function() {
                    elements.editProfileForm.style.display = 'none';
                    elements.editProfileBtn.style.display = 'block';
                });
            }

            if (elements.editProfileForm) {
                elements.editProfileForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const user = auth.currentUser;
                    if (!user) return;

                    try {
                        const updatedData = {
                            name: elements.editNameInput?.value || 'Not provided',
                            age: parseInt(elements.editAgeInput?.value, 10) || 0,
                            experience: elements.editExperienceInput?.value || 'Not provided'
                        };

                        await updateDoc(doc(db, "users", user.uid), updatedData);
                        console.log("Profile updated successfully:", updatedData);
                        
                        // Update display
                        safeUpdateElement(elements.profileName, updatedData.name);
                        safeUpdateElement(elements.profileAge, updatedData.age);
                        safeUpdateElement(elements.profileExperience, updatedData.experience);
                        safeUpdateElement(elements.profileEmail, user.email);

                        // Hide form
                        elements.editProfileForm.style.display = 'none';
                        elements.editProfileBtn.style.display = 'block';
                    } catch (error) {
                        console.error("Error updating profile:", error);
                        alert("Error updating profile. Please try again.");
                    }
                });
            }
        });
    </script>
</body>
</html> 